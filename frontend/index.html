<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="https://cdn-icons-png.flaticon.com/512/3225/3225188.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI PDF Chatbot Pro</title>
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Custom Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- DEFINITIVE FIX: Embedded SVG Icons ---
        // By embedding the icons directly, we remove all network-related timing and security issues.
        // This makes the application fully self-contained and guarantees the icons are always available.
        const Icon = ({ size = 24, className, children }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const FileText = ({ size, className }) => (
            <Icon size={size} className={className}>
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" x2="8" y1="13" y2="13" />
                <line x1="16" x2="8" y1="17" y2="17" />
                <line x1="10" x2="8" y1="9" y2="9" />
            </Icon>
        );

        const X = ({ size, className }) => (
            <Icon size={size} className={className}>
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </Icon>
        );

        const UploadCloud = ({ size, className }) => (
            <Icon size={size} className={className}>
                <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                <path d="M12 12v9" />
                <path d="m16 16-4-4-4 4" />
            </Icon>
        );

        const Loader2 = ({ size, className }) => (
            <Icon size={size} className={className}>
                <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            </Icon>
        );

        const MessageSquarePlus = ({ size, className }) => (
            <Icon size={size} className={className}>
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2" />
                <line x1="12" y1="7" x2="12" y2="13" />
                <line x1="9" y1="10" x2="15" y2="10" />
            </Icon>
        );

        const MessageCircle = ({ size, className }) => (
            <Icon size={size} className={className}>
                <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/>
            </Icon>
        );

        const SendHorizontal = ({ size, className }) => (
            <Icon size={size} className={className}>
                <path d="m3 3 3 9-3 9 19-9Z"/>
                <path d="M6 12h16"/>
            </Icon>
        );


        const App = () => {
            // --- State Management ---
            const [sessionId, setSessionId] = useState(null);
            const [chatHistory, setChatHistory] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isReplying, setIsReplying] = useState(false);
            const [error, setError] = useState(null);
            
            // API Endpoint configuration
            const API_BASE_URL = "http://127.0.0.1:8000";

            // --- UI Component: File Upload Screen ---
            const UploadComponent = ({ setSessionId, setIsProcessing, setError, isProcessing, error }) => {
                const [files, setFiles] = useState([]);
                const fileInputRef = useRef(null);

                const handleFileChange = (event) => {
                    setFiles([...event.target.files]);
                    setError(null);
                };

                const handleProcess = async () => {
                    if (files.length === 0) {
                        setError("Please select at least one PDF file.");
                        return;
                    }
                    setIsProcessing(true);
                    setError(null);

                    const formData = new FormData();
                    files.forEach(file => {
                        formData.append("pdf_files", file);
                    });

                    try {
                        const response = await fetch(`${API_BASE_URL}/process-pdfs/`, {
                            method: "POST",
                            body: formData,
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || "An error occurred during processing.");
                        }

                        const data = await response.json();
                        setSessionId(data.session_id);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setIsProcessing(false);
                    }
                };

                const FileChip = ({ file, onRemove }) => (
                    <div className="bg-slate-600 text-white text-sm font-medium px-3 py-1 rounded-full flex items-center animate-fade-in">
                        <span>{file.name}</span>
                        <button onClick={() => onRemove(file)} className="ml-2 text-slate-400 hover:text-white">
                            <X size={14} />
                        </button>
                    </div>
                );

                return (
                    <div className="w-full h-full flex flex-col items-center justify-center p-8 bg-slate-800 rounded-2xl shadow-2xl">
                        <div className="w-full max-w-lg text-center">
                            <FileText size={48} className="mx-auto text-slate-400 mb-4" />
                            <h1 className="text-3xl font-bold mb-2">Chat with your Documents</h1>
                            <p className="text-slate-400 mb-8">Upload your PDFs and start a conversation in seconds.</p>
                            
                            <div 
                                className="border-2 border-dashed border-slate-600 rounded-lg p-10 cursor-pointer hover:border-indigo-500 hover:bg-slate-700/50 transition-all duration-300"
                                onClick={() => fileInputRef.current.click()}
                            >
                                <UploadCloud size={40} className="mx-auto text-slate-500 mb-4" />
                                <p className="font-semibold">Click to upload or drag and drop</p>
                                <p className="text-xs text-slate-500 mt-1">Supports multiple PDF files</p>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileChange}
                                    multiple
                                    accept=".pdf"
                                    className="hidden"
                                />
                            </div>

                            {files.length > 0 && (
                                <div className="mt-6">
                                    <h3 className="font-semibold mb-3 text-left">Selected Files:</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {files.map((file, index) => (
                                            <FileChip key={index} file={file} onRemove={(f) => setFiles(files.filter(item => item !== f))} />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {error && <p className="text-red-400 mt-4 text-sm">{error}</p>}
                            
                            <button
                                onClick={handleProcess}
                                disabled={isProcessing || files.length === 0}
                                className="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg mt-8 hover:bg-indigo-700 disabled:bg-slate-700 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center"
                            >
                                {isProcessing ? (
                                    <>
                                        <Loader2 className="animate-spin mr-2" size={20}/>
                                        Processing...
                                    </>
                                ) : (
                                    <>
                                        <MessageSquarePlus size={20} className="mr-2"/>
                                        Start Conversation
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                );
            };

            // --- UI Component: Chat Screen ---
            const ChatComponent = ({ sessionId, chatHistory, setChatHistory, isReplying, setIsReplying, setError }) => {
                const [input, setInput] = useState("");
                const chatEndRef = useRef(null);

                useEffect(() => {
                    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                }, [chatHistory, isReplying]);

                const handleSend = async () => {
                    if (!input.trim()) return;

                    const userMessage = { role: 'user', content: input };
                    setChatHistory(prev => [...prev, userMessage]);
                    setIsReplying(true);
                    setInput("");
                    setError(null);

                    try {
                        const response = await fetch(`${API_BASE_URL}/chat/`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ session_id: sessionId, question: input }),
                        });

                        if (!response.ok) {
                           const errorData = await response.json();
                           throw new Error(errorData.detail || "An error occurred while getting a response.");
                        }

                        const data = await response.json();
                        const botMessage = { role: 'bot', content: data.answer };
                        setChatHistory(prev => [...prev, botMessage]);

                    } catch (err) {
                        setError(err.message);
                        setChatHistory(prev => prev.filter(msg => msg !== userMessage));
                    } finally {
                        setIsReplying(false);
                    }
                };

                const ChatBubble = ({ message }) => {
                    const isUser = message.role === 'user';
                    return (
                        <div className={`flex items-start gap-3 my-4 ${isUser ? 'justify-end' : 'justify-start'}`}>
                            {!isUser && <div className="w-8 h-8 rounded-full bg-indigo-500 flex-shrink-0"></div>}
                            <div className={`p-4 rounded-2xl max-w-lg ${isUser ? 'bg-indigo-600 rounded-br-none' : 'bg-slate-700 rounded-bl-none'}`}>
                                <p className="text-white">{message.content}</p>
                            </div>
                        </div>
                    );
                };

                return (
                    <div className="w-full h-full flex flex-col bg-slate-800 rounded-2xl shadow-2xl">
                        <div className="p-4 border-b border-slate-700 flex items-center">
                             <MessageCircle size={24} className="text-indigo-400 mr-3"/>
                             <h2 className="text-xl font-bold">Chat Panel</h2>
                        </div>
                        <div className="flex-1 p-6 overflow-y-auto no-scrollbar">
                           {chatHistory.map((msg, index) => <ChatBubble key={index} message={msg} />)}
                           {isReplying && (
                               <div className="flex items-start gap-3 my-4 justify-start">
                                    <div className="w-8 h-8 rounded-full bg-indigo-500 flex-shrink-0 animate-pulse"></div>
                                    <div className="p-4 rounded-2xl max-w-lg bg-slate-700 rounded-bl-none flex items-center">
                                        <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce mr-2"></div>
                                        <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce mr-2" style={{animationDelay: '0.2s'}}></div>
                                        <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                                    </div>
                               </div>
                           )}
                           <div ref={chatEndRef} />
                        </div>
                        {error && <p className="text-red-400 px-6 pb-2 text-sm">{error}</p>}
                        <div className="p-4 border-t border-slate-700">
                            <div className="relative">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && !isReplying && handleSend()}
                                    placeholder="Ask a question about your documents..."
                                    className="w-full bg-slate-900 border border-slate-600 rounded-lg py-3 pl-4 pr-12 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    disabled={isReplying}
                                />
                                <button
                                    onClick={handleSend}
                                    disabled={isReplying || !input.trim()}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors"
                                >
                                    <SendHorizontal size={20} />
                                </button>
                            </div>
                        </div>
                    </div>
                )
            };
            
            // --- Main App Layout ---
            return (
                <div className="w-screen h-screen flex items-center justify-center p-4 sm:p-8">
                    <div className="w-full max-w-4xl h-full max-h-[90vh]">
                        {sessionId ? (
                           <ChatComponent 
                                sessionId={sessionId} 
                                chatHistory={chatHistory} 
                                setChatHistory={setChatHistory} 
                                isReplying={isReplying}
                                setIsReplying={setIsReplying}
                                setError={setError}
                           />
                        ) : (
                           <UploadComponent 
                                setSessionId={setSessionId} 
                                setIsProcessing={setIsProcessing} 
                                isProcessing={isProcessing}
                                error={error}
                                setError={setError}
                           />
                        )}
                    </div>
                </div>
            );
        };
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

